<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="SEO" RequireVersion="8.1" Title="DataForSeo" Id="DataForSeo" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/DataForSeo.xml" HelpUrl="http://seotoolsforexcel.com/DataForSeo/" HelpText="Documentation">

  <Author Name="Victor" Url="http://community.seotoolsforexcel.com/users/diskborste/activity"/>

  <Settings HelpText="What's this?" HelpUrl="">
    <Text Id="Email" Title="Email" Required="true" HelpUrl=""/>
    <Text Id="Key" Title="API Key" Required="true" HelpUrl=""/>
  </Settings>

  <RestConnector Id="Locations" Title="Locations" HelpUrl="https://docs.dataforseo.com/#list-of-locations" Hidden="true">
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/cmn_locations
				?search_engine=google
				&country_iso_code=se
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.results.*">
        <JsonPath Expr="loc_id" Id="Id" Title="Id" Converter="Int" HelpText=""/>
        <JsonPath Expr="loc_name" Id="Name" Title="Name" Converter="String" HelpText=""/>
      </JsonPath>
    </Parse>
  </RestConnector>

  <RestConnector Id="SearchEngines" Title="Search Engines" HelpUrl="https://docs.dataforseo.com/#list-of-search-engines" Hidden="true">
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/cmn_se
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.results.*">
        <JsonPath Expr="se_id" Id="Id" Title="Id" Converter="Int" HelpText=""/>
        <JsonPath Expr="se_name" Id="Name" Title="Name" Converter="String" HelpText=""/>
      </JsonPath>
    </Parse>
  </RestConnector>
  
  <RestConnector Id="SerpInit" Hidden="true">
   <Parameters>
      <Text Id="SearchEngineId"/>
      <Text Id="LocationId"/>
      <Text Id="Query"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/srp_tasks_post
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
        <RequestBody>
          <![CDATA[
          {
            "data":
            {
              "@(Utils.NewGuid())": {
                "se_id":"@(Model.SearchEngineId)",
                "loc_id":"@(Model.LocationId)",
                "key":"@(Model.Query.Replace("\"","\\\""))",
                "priority":2
              }
            }
          }
					]]>
        </RequestBody>
      </HttpSettings>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.results.*">
        <JsonPath Expr="task_id" Id="TaskId"/>
      </JsonPath>
    </Parse>
  </RestConnector>

  <RestConnector Id="Serp" Title="SERP" HelpUrl="https://docs.dataforseo.com/#setting-serp-tasks">
   <Parameters>
     <Text Id="SearchEngineId" Title="Search Engine Id" DefaultValue="" Required="true" Debug.DefaultValue="2893" Select.Connector="SearchEngines" Select.IdField="Id" Select.TitleField="Name"/>
     <Text Id="LocationId" Title="Location Id" DefaultValue="" Required="true" Debug.DefaultValue="2752" Select.Connector="Locations" Select.IdField="Id" Select.TitleField="Name"/>
     <Text Id="Query" Title="Query" Debug.DefaultValue="&quot;sms lÃ¥n&quot;" Required="true"/>
    </Parameters>
    <Prepare>
      <Connector Id="SerpInit" Parameters="SearchEngineId,LocationId,Query"/>
    </Prepare>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/srp_tasks_get/@(Model.TaskId)
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.results.organic.*">
        <JsonPath Expr="result_position" Id="OrganicPosition" Title="Organic Position" Converter="Long" HelpText="" Checked="true"/>
        <JsonPath Expr="result_url" Id="OrganicUrl" Title="Organic URL" Converter="String" HelpText="" Checked="true"/>
        <JsonPath Expr="result_title" Id="OrganicTitle" Title="Organic Title" Converter="String" HelpText="" Checked="true"/>
        <JsonPath Expr="result_snippet" Id="OrganicSnippet" Title="Organic Snippet" Converter="String" HelpText="" Checked="true"/>
      </JsonPath>
      <JsonPath Expr="$.results.paid.*">
        <JsonPath Expr="result_position" Id="PaidPosition" Title="Paid Position" Converter="Long" HelpText="" Checked="false"/>
        <JsonPath Expr="result_url" Id="PaidUrl" Title="Paid URL" Converter="String" HelpText="" Checked="false"/>
        <JsonPath Expr="result_title" Id="PaidTitle" Title="Paid Title" Converter="String" HelpText="" Checked="false"/>
        <JsonPath Expr="result_snippet" Id="PaidSnippet" Title="Paid Snippet" Converter="String" HelpText="" Checked="false"/>
      </JsonPath>
    </Parse>
    <Fail>
      <JsonPath Expr="error.message" Fail.If="RegexMatches" Fail.ComparedTo="did not return results" Fail.Action="EmptyResult"/>
      <JsonPath Expr="error.message" Fail.If="IsNotEmpty" Fail.Action="Message" Fail.Message="Failed '{0}.'"/>
      <JsonPath Expr="results_count" Fail.If="IsEqual" Fail.ComparedTo="0" Fail.Action="Retry" Fail.RetryAfter="5000" Fail.RetryTimes="100"/>
    </Fail>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[
    string CreateBasicAuth()
    {
      string AuthString = Convert.ToBase64String(ASCIIEncoding.ASCII.GetBytes(Model.Email + ":" + Model.Key));
      return AuthString;
    }
    ]]>
  </RazorFunctions>

</Suite>