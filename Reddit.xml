<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="Social" RequireVersion="8.2" Title="Reddit" Id="Reddit" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/Reddit.xml" HelpUrl="http://seotoolsforexcel.com/reddit/" HelpText="Documentation">

  <Author Name="Victor" Url="http://community.seotoolsforexcel.com/users/diskborste/activity"/>

  <Resources>
    <Resource Id="Fail">
			<Fail>
				<JsonPath Expr="$.message"/>
			</Fail>
    </Resource>
  </Resources>

  <RestConnector Id="ThreadSearch" Title="Thread Search" Group="Threads" HelpUrl="https://www.reddit.com/dev/api#GET_search">
    <Parameters>
      <Text Id="Query" Title="Query" Required="true" Debug.DefaultValue="aftonbladet"/>
      <Select Id="Sort" Title="Sort" DefaultValue="relevance">
        <DataSource>
					<Item Id="relevance" Title="Relevance"/>
					<Item Id="hot" Title="Hot"/>
					<Item Id="top" Title="Top"/>
					<Item Id="new" Title="New"/>
					<Item Id="comments" Title="Comments"/>
        </DataSource>
      </Select>
    </Parameters>
    <Paging PageSize="25" EvenPages="false">
      <Parse>
        <JsonPath Id="Cursor" Expr="data.after"/>
      </Parse>
    </Paging>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://www.reddit.com/search.json?q=@(Utils.UrlEncode(Model.Query))
        &count=@(Model.PageCursor.PageSize)
        &sort=@(Model.Sort)
        @(Model.PageCursor.Page != 0 ? "&after=" + Model.Cursor : "")
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="data.children[*].data">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="String"/>
        <JsonPath Expr="title" Id="Title" Title="Title" Converter="String"/>
        <JsonPath Expr="created" Id="Created" Title="Created" Converter="DateTime" Converter.SourceFormat="Unix"/>
        <Compute Expr="https://www.reddit.com@(Model.Inp)" Id="Url" Title="URL"  Converter="String">
					<JsonPath Expr="permalink" Id="Inp" DefaultValue=""/>
        </Compute>
        <JsonPath Expr="num_comments" Id="Comments" Title="Comments" Converter="Int"/>
        <JsonPath Expr="likes" Id="Likes" Title="Likes" Converter="Int"/>
        <JsonPath Expr="ups" Id="Ups" Title="Ups" Converter="Int"/>
        <JsonPath Expr="downs" Id="Downs" Title="Downs" Converter="Int"/>
        <JsonPath Expr="score" Id="Score" Title="Score" Converter="Int"/>
        <JsonPath Expr="author" Id="Author" Title="Author" Converter="String"/>
        <JsonPath Expr="subreddit_name_prefixed" Id="SubReddit" Title="SubReddit" Converter="String"/>
      </JsonPath>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="Comments" Title="Comments from Thread" Group="Comments" HelpUrl="https://www.reddit.com/dev/api#GET_comments_{article}">
    <Parameters>
      <Text Id="ThreadId" Title="Thread Id" Required="true" Debug.DefaultValue="2vnlux"/>
      <Select Id="Sort" Title="Sort" DefaultValue="top">
        <DataSource>
					<Item Id="confidence" Title="Confidence"/>
					<Item Id="top" Title="Top"/>
					<Item Id="new" Title="New"/>
					<Item Id="controversial" Title="Controversial"/>
					<Item Id="old" Title="Old"/>
					<Item Id="random" Title="Random"/>
					<Item Id="qa" Title="QA"/>
					<Item Id="live" Title="Live"/>
        </DataSource>
      </Select>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://www.reddit.com/comments/@(Model.ThreadId).json?sort=@(Model.Sort)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.[1].data.children[*].data">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="String"/>
        <JsonPath Expr="created" Id="Created" Title="Created" Converter="DateTime" Converter.SourceFormat="Unix"/>
        <JsonPath Expr="likes" Id="Likes" Title="Likes" Converter="Int"/>
        <JsonPath Expr="ups" Id="Ups" Title="Ups" Converter="Int"/>
        <JsonPath Expr="downs" Id="Downs" Title="Downs" Converter="Int"/>
        <JsonPath Expr="score" Id="Score" Title="Score" Converter="Int"/>
        <JsonPath Expr="controversiality" Id="Controversiality" Title="Controversiality" Converter="Int"/>
        <JsonPath Expr="author" Id="Author" Title="Author" Converter="String"/>
      </JsonPath>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="CommentsLookup" Title="Comments Lookup" Group="Comments" HelpUrl="https://www.reddit.com/dev/api#GET_api_info">
    <Parameters>
      <Text Id="CommentIds" Title="Comment Id"  Required="true" Debug.DefaultValue="cojbps1" HelpText="Enter one or more Comment Ids separated by a new line" Multiline="true"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://www.reddit.com/api/info.json?id=t1_@(FetchCommentBatch())
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="data.children[*].data">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="String"/>
        <JsonPath Expr="created" Id="Created" Title="Created" Converter="DateTime" Converter.SourceFormat="Unix"/>
        <JsonPath Expr="likes" Id="Likes" Title="Likes" Converter="Int"/>
        <JsonPath Expr="ups" Id="Ups" Title="Ups" Converter="Int"/>
        <JsonPath Expr="downs" Id="Downs" Title="Downs" Converter="Int"/>
        <JsonPath Expr="score" Id="Score" Title="Score" Converter="Int"/>
        <JsonPath Expr="controversiality" Id="Controversiality" Title="Controversiality" Converter="Int"/>
        <JsonPath Expr="author" Id="Author" Title="Author" Converter="String"/>
      </JsonPath>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="ThreadLookup" Title="Threads Lookup" Group="Threads" HelpUrl="https://www.reddit.com/dev/api#GET_api_info">
    <Parameters>
      <Text Id="ThreadIds" Title="Thread Id" Required="true" Debug.DefaultValue="2yoeo1" HelpText="Enter one or more Comment Ids separated by a new line" Multiline="true"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://www.reddit.com/api/info.json?id=t3_@(FetchThreadBatch())
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="data.children[*].data">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="String"/>
        <JsonPath Expr="title" Id="Title" Title="Title" Converter="String"/>
        <JsonPath Expr="created" Id="Created" Title="Created" Converter="DateTime" Converter.SourceFormat="Unix"/>
        <Compute Id="Url" Title="URL"  Converter="String">
          <Compute.Expr>
            <![CDATA[
						https://www.reddit.com@(Model.Inp)
            ]]>
          </Compute.Expr>
					<JsonPath Expr="permalink" Id="Inp" DefaultValue=""/>
        </Compute>
        <JsonPath Expr="num_comments" Id="Comments" Title="Comments" Converter="Int"/>
        <JsonPath Expr="likes" Id="Likes" Title="Likes" Converter="Int"/>
        <JsonPath Expr="ups" Id="Ups" Title="Ups" Converter="Int"/>
        <JsonPath Expr="downs" Id="Downs" Title="Downs" Converter="Int"/>
        <JsonPath Expr="score" Id="Score" Title="Score" Converter="Int"/>
        <JsonPath Expr="author" Id="Author" Title="Author" Converter="String"/>
        <JsonPath Expr="subreddit_name_prefixed" Id="SubReddit" Title="SubReddit" Converter="String"/>
      </JsonPath>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="UserComments" Title="Comments from User" Group="Comments" HelpUrl="https://www.reddit.com/dev/api#GET_user_{username}_comments">
    <Parameters>
      <Text Id="Username" Title="Username" Required="true" Debug.DefaultValue="spez"/>
      <Select Id="Sort" Title="Sort" DefaultValue="new">
        <DataSource>
					<Item Id="hot" Title="Hot"/>
					<Item Id="top" Title="Top"/>
					<Item Id="new" Title="New"/>
					<Item Id="controversial" Title="Controversial"/>
        </DataSource>
      </Select>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://www.reddit.com/user/@(Model.Username)/comments.json?sort=@(Model.Sort)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.data.children[*].data">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="String"/>
         <JsonPath Expr="created" Id="Created" Title="Created" Converter="DateTime" Converter.SourceFormat="Unix"/>Â´
        <JsonPath Expr="body" Id="Body" Title="Body" Converter="String"/>
        <JsonPath Expr="ups" Id="Ups" Title="Ups" Converter="Int"/>
        <JsonPath Expr="downs" Id="Downs" Title="Downs" Converter="Int"/>
        <JsonPath Expr="score" Id="Score" Title="Score" Converter="Int"/>
        <JsonPath Expr="controversiality" Id="Controversiality" Title="Controversiality" Converter="Int"/>
      </JsonPath>
    </Parse>
		<Resource Id="Fail"/>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[
    string FetchThreadBatch() {
      string[] lines = ((string)Model.ThreadIds).Trim().Split('\n').Select(e => e.Trim()).Where(e => !string.IsNullOrEmpty(e)).ToArray();
      return string.Join(",t3_",lines.Select((e, i) => Utils.UrlEncode(e)).ToArray());
    }
    string FetchCommentBatch() {
      string[] lines = ((string)Model.CommentIds).Trim().Split('\n').Select(e => e.Trim()).Where(e => !string.IsNullOrEmpty(e)).ToArray();
      return string.Join(",t1_",lines.Select((e, i) => Utils.UrlEncode(e)).ToArray());
    }
    ]]>
  </RazorFunctions>

</Suite>