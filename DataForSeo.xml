<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="SEO" RequireVersion="8.1" Title="DataForSeo" Id="DataForSeo" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/DataForSeo.xml" HelpUrl="http://seotoolsforexcel.com/DataForSeo/" HelpText="Documentation">

  <Author Name="Victor" Url="http://community.seotoolsforexcel.com/users/diskborste/activity"/>

  <Settings HelpText="What's this?" HelpUrl="">
    <Text Id="Email" Title="Email" Required="true" HelpUrl=""/>
    <Text Id="Key" Title="API Key" Required="true" HelpUrl=""/>
  </Settings>

  <RestConnector Id="Locations" Title="Locations" HelpUrl="https://docs.dataforseo.com/#list-of-locations" Hidden="true">
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/cmn_locations
				?search_engine=google
				&country_iso_code=se
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.results.*">
        <JsonPath Expr="loc_id" Id="Id" Title="Id" Converter="Int" HelpText=""/>
        <JsonPath Expr="loc_name" Id="Name" Title="Name" Converter="String" HelpText=""/>
      </JsonPath>
    </Parse>
  </RestConnector>

  <RestConnector Id="SearchEngines" Title="Search Engines" HelpUrl="https://docs.dataforseo.com/#list-of-search-engines" Hidden="true">
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/cmn_se
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.results.*">
        <JsonPath Expr="se_id" Id="Id" Title="Id" Converter="Int" HelpText=""/>
        <JsonPath Expr="se_name" Id="Name" Title="Name" Converter="String" HelpText=""/>
      </JsonPath>
    </Parse>
  </RestConnector>
  
  <RestConnector Id="SerpInit" Hidden="true">
   <Parameters>
      <Text Id="SearchEngineId"/>
      <Text Id="LocationId"/>
      <Text Id="Query"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/srp_tasks_post
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
        <!-- todo: handle \" encoding -->
        <RequestBody>
          <![CDATA[
          {
            "data":
            {
              "@(Utils.NewGuid())": {
                "se_id":"@(Model.SearchEngineId)",
                "loc_id":"@(Model.LocationId)",
                "key":"@(Model.Query)"
              }
            }
          }
					]]>
        </RequestBody>
      </HttpSettings>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.results.*">
        <JsonPath Expr="task_id" Id="TaskId"/>
      </JsonPath>
    </Parse>
  </RestConnector>
  
  <RestConnector Id="SerpCheck" Hidden="false">
    <Parameters>
      <Text Id="SearchEngineId" Debug.DefaultValue="2893"/>
      <Text Id="LocationId" Debug.DefaultValue="2752"/>
      <Text Id="Query" Debug.DefaultValue="seotools"/>
    </Parameters>
    <Prepare>
      <Connector Id="SerpInit" Parameters="SearchEngineId,LocationId,Query"/>
    </Prepare>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/srp_tasks_get
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
    </Fetch>
    <!-- todo: use regexp -->
    <Parse>
      <Xpath Expr="//*[text()='@(Model.TaskId)']" Id="TaskId"/>
    </Parse>
    <Fail>
      <XPath Expr="//*[text()='@(Model.TaskId)']" Fail.If="IsEmpty" Fail.Action="Retry" Fail.RetryAfter="5000" Fail.RetryTimes="10"/>
    </Fail>
  </RestConnector>

  <RestConnector Id="Serp" Title="SERP" HelpUrl="https://docs.dataforseo.com/#setting-serp-tasks">
   <Parameters>
     <Text Id="SearchEngineId" Title="Search Engine Id" DefaultValue="" Required="true" Debug.DefaultValue="2893" Select.Connector="SearchEngines" Select.IdField="Id" Select.TitleField="Name"/>
     <Text Id="LocationId" Title="Location Id" DefaultValue="" Required="true" Debug.DefaultValue="2752" Select.Connector="Locations" Select.IdField="Id" Select.TitleField="Name"/>
     <Text Id="Query" Title="Query" Debug.DefaultValue="seotools" Required="true"/>
     <Radio Id="Type" Title="Type" DefaultValue="organic">
        <DataSource>
          <Item Id="organic" Title="Organic" />
          <Item Id="paid" Title="Paid" />
        </DataSource>
      </Radio>
    </Parameters>
    <Prepare>
      <Connector Id="SerpCheck" Parameters="SearchEngineId,LocationId,Query"/>
    </Prepare>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://api.dataforseo.com/v2/srp_tasks_get/@(Model.TaskId)
        ]]>
      </Fetch.Url>
      <HttpSettings>
        <RequestContentType>application/json; charset=utf-8</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.results.@(Model.Type).*">
        <JsonPath Expr="result_position" Id="Position" Title="Position" Converter="Long" HelpText=""/>
        <JsonPath Expr="result_url" Id="Url" Title="URL" Converter="String" HelpText=""/>
        <JsonPath Expr="result_title" Id="Title" Title="Title" Converter="String" HelpText=""/>
        <JsonPath Expr="result_snippet" Id="Snippet" Title="Snippet" Converter="String" HelpText=""/>
      </JsonPath>
      <!-- show all -->
    </Parse>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[
    string CreateBasicAuth()
    {
      string AuthString = Convert.ToBase64String(ASCIIEncoding.ASCII.GetBytes(Model.Email + ":" + Model.Key));
      return AuthString;
    }
    ]]>
  </RazorFunctions>

</Suite>