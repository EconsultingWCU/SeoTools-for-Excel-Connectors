<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="Locations" RequireVersion="8.1.20" Title="Google Places" Id="GooglePlaces" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/GooglePlaces.xml" HelpUrl="http://seotoolsforexcel.com/google-places/" HelpText="Documentation">

  <Author Name="Victor" Url="http://community.seotoolsforexcel.com/users/diskborste/activity"/>

  <Settings HelpText="What's this?" HelpUrl="http://seotoolsforexcel.com/google-places/">
    <Text Id="ApiKey" Title="ApiKey" Required="true" HelpUrl="http://seotoolsforexcel.com/google-places/"/>
  </Settings>

  <RestConnector Id="SearchText" Title="Search by Text" HelpUrl="https://developers.google.com/places/web-service/search">
    <Parameters>
      <Text Id="Query" Title="Search" Debug.DefaultValue="pizza" Required="true"/>
      <Checkbox Id="OpenNow" Title="Open Now" DefaultValue="false"/>
      <Text Id="Latitude" Title="Latitude (DDD.DDDDD°)" DefaultValue="" Required="false" Debug.DefaultValue="59.34"/>
      <Text Id="Longitude" Title="Longitude (DDD.DDDDD°)" DefaultValue="" Required="false" Debug.DefaultValue="17.94"/>
      <Number Id="Radius" Title="Radius (Meter | Max = 50000)" DefaultValue="10000" Required="false"/>
      <Select Id="Country" Title="Preferred Country" Required="" DefaultValue="All">
        <DataSource>
					<Item Id="all" Title="All"/>
          <ISOCountryCodes/>
        </DataSource>
      </Select>
    </Parameters>
    <Paging PageSize="20" MaxTake="20"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://maps.googleapis.com/maps/api/place/textsearch/json?key=@Model.ApiKey&query=@Model.Query
        @(Model.Country != "All" ? "&region=" + Model.Country.ToUpper() : "")
        @(Model.OpenNow == true ? "&opennow=true" : "")
        @if(!string.IsNullOrEmpty(Model.Latitude) && !string.IsNullOrEmpty(Model.Longitude) && Model.Radius >= 0)
        {
          @: &location=@(Model.Latitude),@(Model.Longitude)&radius=@(Model.Radius)
        }
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="results[*]">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="String"/>
        <JsonPath Expr="name" Id="Name" Title="Name" Converter="String"/>
        <JsonPath Expr="place_id" Id="PlaceId" Title="Place Id" Converter="String"/>
        <JsonPath Expr="formatted_address" Id="Address" Title="Address" Converter="String"/>
        <JsonPath Expr="types[0]" Id="Type" Title="Type" Converter="String"/>
        <JsonPath Expr="geometry.location.lat" Id="Latitude" Title="Latitude" Converter="String"/>
        <JsonPath Expr="geometry.location.lng" Id="Longitude" Title="Longitude" Converter="String"/>
        <JsonPath Expr="price_level" Id="PriceLevel" Title="Price Level" Converter="Double" DefaultValue=""/>
        <JsonPath Expr="rating" Id="Rating" Title="Rating" Converter="Double" DefaultValue=""/>
        <Compute Id="Photo" Title="Photo" DefaultValue="">
          <Compute.Expr>
            <![CDATA[
            @{
              Regex regex = new Regex(@"""(.*?)""");
              Match match = regex.Match(Model.PhotoInput);
              string output = match.Groups[1].Value;
            }
            @output
            ]]>
          </Compute.Expr>
        <JsonPath Expr="photos[*].html_attributions[0]" Id="PhotoInput" Converter="String" DefaultValue=""/>
        </Compute>
        <JsonPath Expr="opening_hours.open_now" Id="OpenNow" Title="Open Now" Converter="Bool" DefaultValue=""/>
      </JsonPath>
    </Parse>
  </RestConnector>

  <RestConnector Id="SearchNearby" Title="Search Nearby" HelpUrl="https://developers.google.com/places/web-service/search">
    <Parameters>
      <Text Id="Latitude" Title="Latitude (DDD.DDDDD°)" DefaultValue="" Required="true" Debug.DefaultValue="59.34"/>
      <Text Id="Longitude" Title="Longitude (DDD.DDDDD°)" DefaultValue="" Required="true" Debug.DefaultValue="17.94"/>
      <Number Id="Radius" Title="Radius (Meter | Max = 50000)" DefaultValue="10000" Required="true"/>
      <Text Id="Query" Title="Optional Query" Debug.DefaultValue="pizza" Required="true"/>
      <Checkbox Id="OpenNow" Title="Open Now" DefaultValue="false"/>
      <Select Id="Country" Title="Preferred Country" Required="" DefaultValue="All">
        <DataSource>
					<Item Id="all" Title="All"/>
          <ISOCountryCodes/>
        </DataSource>
      </Select>
		</Parameters>
    <Paging PageSize="20" MaxTake="20"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://maps.googleapis.com/maps/api/place/nearbysearch/json?key=@Model.ApiKey&query=@Model.Query
        &location=@(Model.Latitude),@(Model.Longitude)&radius=@(Model.Radius)
        @(Model.Country != "All" ? "&region=" + Model.Country.ToUpper() : "")
        @(Model.OpenNow == true ? "&opennow=true" : "")
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="results[*]">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="String"/>
        <JsonPath Expr="name" Id="Name" Title="Name" Converter="String"/>
        <JsonPath Expr="place_id" Id="PlaceId" Title="Place Id" Converter="String"/>
        <JsonPath Expr="vicinity" Id="Vicinity" Title="Vicinity" Converter="String"/>
        <JsonPath Expr="types[0]" Id="Type" Title="Type" Converter="String"/>
        <JsonPath Expr="geometry.location.lat" Id="Latitude" Title="Latitude" Converter="String"/>
        <JsonPath Expr="geometry.location.lng" Id="Longitude" Title="Longitude" Converter="String"/>
        <JsonPath Expr="price_level" Id="PriceLevel" Title="Price Level" Converter="Double" DefaultValue=""/>
        <JsonPath Expr="rating" Id="Rating" Title="Rating" Converter="Double" DefaultValue=""/>
        <Compute Id="Photo" Title="Photo" DefaultValue="">
          <Compute.Expr>
            <![CDATA[
            @{
              Regex regex = new Regex(@"""(.*?)""");
              Match match = regex.Match(Model.PhotoInput);
              string output = match.Groups[1].Value;
            }
            @output
            ]]>
          </Compute.Expr>
        <JsonPath Expr="photos[*].html_attributions[0]" Id="PhotoInput" Converter="String" DefaultValue=""/>
        </Compute>
        <JsonPath Expr="opening_hours.open_now" Id="OpenNow" Title="Open Now" Converter="Bool" DefaultValue=""/>
      </JsonPath>
    </Parse>
  </RestConnector>

  <RestConnector Id="PlaceDetails" Title="Place Details" HelpUrl="https://developers.google.com/places/web-service/details">
    <Parameters>
      <Text Id="PlaceId" Title="Place Id" Debug.DefaultValue="ChIJxU_2nmCdX0YRKvB-sHRf92U" Required="true"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://maps.googleapis.com/maps/api/place/details/json?key=@Model.ApiKey
        &placeid=@Model.PlaceId
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="result">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="String"/>
        <JsonPath Expr="name" Id="Name" Title="Name" Converter="String"/>
        <JsonPath Expr="formatted_address" Id="FormattedAdress" Title="Address" Converter="String" DefaultValue=""/>
        <JsonPath Expr="formatted_phone_number" Id="FormattedPhone" Title="Phone" Converter="String" DefaultValue=""/>
        <JsonPath Expr="international_phone_number" Id="InternationalPhone" Title="International Phone" Converter="String" DefaultValue=""/>
        <JsonPath Expr="website" Id="Website" Title="Website" Converter="String" DefaultValue=""/>
        <JsonPath Expr="vicinity" Id="Vicinity" Title="Vicinity" Converter="String"/>
        <JsonPath Expr="types[0]" Id="Type" Title="Type" Converter="String"/>
        <JsonPath Expr="geometry.location.lat" Id="Latitude" Title="Latitude" Converter="String"/>
        <JsonPath Expr="geometry.location.lng" Id="Longitude" Title="Longitude" Converter="String"/>
        <JsonPath Expr="price_level" Id="PriceLevel" Title="Price Level" Converter="Double" DefaultValue=""/>
        <JsonPath Expr="rating" Id="Rating" Title="Rating" Converter="Double" DefaultValue=""/>
        <Compute Id="Photo" Title="Photo" DefaultValue="">
          <Compute.Expr>
            <![CDATA[
            @{
              Regex regex = new Regex(@"""(.*?)""");
              Match match = regex.Match(Model.PhotoInput);
              string output = match.Groups[1].Value;
            }
            @output
            ]]>
          </Compute.Expr>
        <JsonPath Expr="photos[*].html_attributions[0]" Id="PhotoInput" Converter="String" DefaultValue=""/>
        </Compute>
        <JsonPath Expr="opening_hours.open_now" Id="OpenNow" Title="Open Now" Converter="Bool" DefaultValue=""/>
      </JsonPath>
    </Parse>
  </RestConnector>

</Suite>