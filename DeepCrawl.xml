<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="Scraping" Title="DeepCrawl" Id="DeepCrawl" RequireVersion="6.0.0" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/DeepCrawl.xml" HelpUrl="http://seotoolsforexcel.com/DeepCrawl/" HelpText="Documentation">

  <Author Name="Victor Sandberg" Url="http://community.seotoolsforexcel.com/users/diskborste/activity" />

  <Settings HelpText="What's this?" HelpUrl="http://seotoolsforexcel.com/DeepCrawl/">
    <Text Id="APIKeyValue" Title="API Key Value" Required="true" HelpUrl="http://seotoolsforexcel.com/DeepCrawl/"/>
    <Text Id="APIKeyId" Title="API Key Id" Required="true" HelpUrl="http://seotoolsforexcel.com/DeepCrawl/"/>
  </Settings>

  <Resources>
    <Resource Id="SortProjects">
		 <Item Id="-finished_at" Title="Last Crawl Date"/>
		 <Item Id="name" Title="Name (A-Z)"/>
		 <Item Id="-name" Title="Name (Z-A)"/>
		 <Item Id="site_primary" Title="URL (A-Z)"/>
		 <Item Id="-site_primary" Title="URL (Z-A)"/>
    </Resource>
  </Resources>

  <RestConnector Id="GenerateToken" Title="GenerateToken" HelpUrl="http://api-docs.deepcrawl.com/" Hidden="false">
    <Fetch>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>application/json</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://prod-1-dc-api-oopeix3r.deepcrawl.com/sessions
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
        <JsonPath Expr="token" Id="Token" Title="Token" Converter="String" HelpText=""/>
    </Parse>
    <Fail>
      <JsonPath Expr="errors.message"/>
    </Fail>
  </RestConnector>

  <RestConnector Id="ListAccounts" Title="List Accounts" HelpUrl="http://api-docs.deepcrawl.com/#accounts-accounts-get" Hidden="false">
		<Prepare>
			<Connector Id="GenerateToken"/>
		</Prepare>
	 <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name='X-Auth-Token'>@(Model.Token)</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://prod-1-dc-api-oopeix3r.deepcrawl.com/accounts
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
        <JsonPath Expr="$[0].id" Id="AccountId" Title="Account Id" Converter="Int" HelpText=""/>
    </Parse>
    <Fail>
      <JsonPath Expr="errors.message"/>
    </Fail>
  </RestConnector>

  <RestConnector Id="ListProjectsHidden" HelpUrl="http://api-docs.deepcrawl.com/#projects-projects-get" Hidden="true">
		<Prepare>
			<Connector Id="GenerateToken"/>		
			<Connector Id="ListAccounts"/>
		</Prepare>		
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name='X-Auth-Token'>@(Model.Token)</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://prod-1-dc-api-oopeix3r.deepcrawl.com/
				accounts/@(Model.AccountId)
				/projects
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.*">
        <JsonPath Expr="id" Id="ProjectId" Title="Project Id" Converter="Int" HelpText=""/>						
        <JsonPath Expr="name" Id="ProjectName" Title="Project Name" Converter="String" HelpText=""/>			
      </JsonPath>
    </Parse>
    <Fail>
      <JsonPath Expr="errors.message"/>
    </Fail>
  </RestConnector>
	
  <RestConnector Id="ListProjects" Title="List Projects" HelpUrl="http://api-docs.deepcrawl.com/#projects-projects-get">
		<Parameters>
      <Select Id="Sorting" Title="Sort Projects by" Required="false" DefaultValue="-finished_at">
        <DataSource>
          <Resource Id="SortProjects"/>
        </DataSource>
      </Select>
			</Parameters>
		<Prepare>
			<Connector Id="GenerateToken"/>		
			<Connector Id="ListAccounts"/>
		</Prepare>		
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name='X-Auth-Token'>@(Model.Token)</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://prod-1-dc-api-oopeix3r.deepcrawl.com/
				accounts/@(Model.AccountId)
				/projects
				?sort=@(Model.Sorting)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.*">
        <JsonPath Expr="name" Id="ProjectName" Title="Project Name" Converter="String" HelpText=""/>
        <JsonPath Expr="active" Id="Active" Title="Active" Converter="Bool" HelpText=""/>
        <JsonPath Expr="_crawls_finished_last_finished_at" Id="LastCrawlDate" Title="Last Crawl Date" Converter="DateTime" HelpText=""/>
        <JsonPath Expr="crawls_count" Id="CrawlCount" Title="Crawl Count" Converter="Int" HelpText=""/>				
      </JsonPath>
    </Parse>
    <Fail>
      <JsonPath Expr="errors.message"/>
    </Fail>
  </RestConnector>

  <RestConnector Id="ListCrawls" Title="List Crawls" HelpUrl="http://api-docs.deepcrawl.com/#crawls-crawls-get">
		<Parameters>
      <Text Id="ProjectIdFilter" Title="Filter Crawl by Project" DefaultValue="" Required="true" Select.Connector="ListProjectsHidden" Select.IdField="ProjectId" Select.TitleField="ProjectName"/>		
      <Select Id="Sorting" Title="Sort Projects by" Required="false" DefaultValue="-finished_at">
        <DataSource>
          <Resource Id="SortProjects"/>
        </DataSource>
      </Select>
			</Parameters>
		<Prepare>
			<Connector Id="GenerateToken"/>		
			<Connector Id="ListAccounts"/>
		</Prepare>		
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name='X-Auth-Token'>@(Model.Token)</Header>
        </RequestHeaders>
      </HttpSettings>/projects/project_id/crawls
      <Fetch.Url>
        <![CDATA[
        https://prod-1-dc-api-oopeix3r.deepcrawl.com/
				accounts/@(Model.AccountId)
				/projects/@(Model.ProjectIdFilter)
				/crawls
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.*">
        <JsonPath Expr="finished_at" Id="DateFinished" Title="Date Finished" Converter="String" HelpText="" DefaultValue=" "/>			
        <JsonPath Expr="status" Id="Status" Title="Status" Converter="String" HelpText="" DefaultValue=" "/>	
        <JsonPath Expr="all_pages_total" Id="UrlsCrawled" Title="URLs Crawled" Converter="Int" HelpText="" DefaultValue=" "/>		
        <JsonPath Expr="uncrawled_urls_total" Id="Uncrawled" Title="Uncrawled" Converter="Int" HelpText="" DefaultValue=" "/>		
        <JsonPath Expr="stats_crawl_levels[(@@.length-1)].level" Id="Depth" Title="Depth" Converter="Int" HelpText="" DefaultValue=" "/>
      </JsonPath>
    </Parse>
    <Fail>
      <JsonPath Expr="errors.message"/>
    </Fail>
  </RestConnector>	

  <RazorFunctions>
    <![CDATA[
    String CreateBasicAuth()
	  {
			string AuthString = Convert.ToBase64String(ASCIIEncoding.ASCII.GetBytes(Model.APIKeyId + ":" + Model.APIKeyValue));
			return AuthString;
    }
    ]]>
		
		
  </RazorFunctions>

</Suite>

<!--
Issues:
- Unable to sort projects by ?sort=crawls_count
- Status not available as value in projects
- URLs not available as value in projects
- Primay Pages not available as value in crawls

Questions:
- What is Crawl Sources?
-->
