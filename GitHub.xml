<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="_OAuth" Title="GitHub" Id="GitHub" RequireVersion="7.0" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/GitHub.xml" HelpUrl="http://seotoolsforexcel.com/github/">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <DefaultOAuthAuthenticator
          StayAuthenticated="true"
          TempCodeName="code"
          AuthUrl="https://github.com/login/oauth/authorize?client_id=5d97ded3f7c763c17a19&amp;redirect_uri={0}&amp;scope=repo%20read:user"

          TwoStep="True"
          TokenConnectorId="AccessToken"
          TokenIdField="Token"
  />

  <Resources>
    <Resource Id="Headers">
      <HttpSettings>
        <RequestHeaders>
          <Header Name="Authorization">token @(Model.Token)</Header>
          <Header Name="Accept">application/vnd.github.v3+json</Header>
        </RequestHeaders>
      </HttpSettings>
    </Resource>
    <Resource Id="Fail">
      <Fail>
        <JsonPath Expr="$.message"/>
      </Fail>
    </Resource>
  </Resources>

  <RestConnector Id="AccessToken" Name="Access Token">
    <Fetch>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>application/x-www-form-urlencoded</RequestContentType>
        <RequestHeaders>
          <Header Name="Accept">application/json</Header>
        </RequestHeaders>
        <RequestBody>
          <![CDATA[client_id=5d97ded3f7c763c17a19&client_secret=ac06255a5f4b771a64d1c4bebdf61f1616b2bcfa&code=@(Model.TempCode)]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        https://github.com/login/oauth/access_token
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Id="Token" Name="Token" Expr="$.access_token"/>
    </Parse>
  </RestConnector>

  <RestConnector Id="Repositories" Title="Repositories" HelpUrl="https://developer.github.com/v3/repos/">
    <Parameters>
      <Select Id="Type" Title="Gists to retrieve" DefaultValue="mine" Required="true">
        <DataSource>
          <Item Id="public" Title="Public"/>
          <Item Id="user" Title="User's repositories"/>
          <Item Id="organization" Title="Organization's repositories"/>
          <Item Id="mine" Title="My repositories"/>
        </DataSource>
      </Select>
      <Text Id="Target" Title="Username/Organization name" Required="False" HelpText="Only required if &quot;User's/organization's repositories &quot; is selected"/>
    </Parameters>
    <Paging PageSize="100" EvenPages="true" MaxTake="1000">
    </Paging>
    <Fetch>
      <Resource Id="Headers"/>
      <Fetch.Url>
        <![CDATA[
        https://api.github.com/
        @if(Model.Type == "public")
        {
          @: repositories
        }
        else if(Model.Type == "mine")
        {
          @: user/repos
        }
        else if(Model.Type == "user" || Model.Type == "organization")
        {
          if (!string.IsNullOrEmpty(Model.Target)) {
            if(Model.Type == "user")
            {
              @: users/@(Model.Target)/repos
            }
            else if(Model.Type == "organization")
            {
              @: orgs/@(Model.Target)/repos
            }
          }
          else {
           throw new Exception("Username is required");
            @: repositories
          }
        }
        @if(Model.PageCursor.Page != 0)
        {
          @: ?since=@(Model.PageCursor.NextSkip)
        }
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.*">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="Int"/>
        <JsonPath Expr="node_id" Id="NodeId" Title="Node ID" Converter="String" Checked="false"/>
        <JsonPath Expr="name" Id="Name" Title="Name" Converter="String"/>
        <JsonPath Expr="full_name" Id="FullName" Title="Full Name" Converter="String"/>
        <JsonPath Expr="owner.login" Id="OwnerLogin" Title="Owner" Converter="String"/>
        <JsonPath Expr="owner.id" Id="OwnerId" Title="Owner ID" Converter="Int"/>
        <JsonPath Expr="owner.avatar_url" Id="OwnerAvatar" Title="Owner Avatar URL" Converter="String" Checked="false"/>
        <JsonPath Expr="owner.type" Id="OwnerType" Title="Owner Type" Converter="String"/>
        <JsonPath Expr="private" Id="Private" Title="Private" Converter="Bool"/>
        <JsonPath Expr="html_url" Id="HtmlUrl" Title="URL" Converter="String"/>
        <JsonPath Expr="description" Id="Description" Title="Description" Converter="String"/>
        <JsonPath Expr="fork" Id="Fork" Title="Fork" Converter="Bool"/>
        <JsonPath Expr="url" Id="Url" Title="API Url" Converter="String" Checked="false"/>
        <JsonPath Expr="created_at" Id="CreatedAt" Title="Created" Converter="DateTime"/>
        <JsonPath Expr="updated_at" Id="UpdatedAt" Title="Updated" Converter="DateTime"/>
        <JsonPath Expr="pushed_at" Id="Pushed_at" Title="Pushed" Converter="DateTime"/>
        <JsonPath Expr="homepage" Id="Homepage" Title="Homepage" Converter="String"/>
        <JsonPath Expr="size" Id="Size" Title="Size" Converter="Int"/>
        <JsonPath Expr="stargazers_count" Id="StargazersCount" Title="Starred" Converter="Int"/>
        <JsonPath Expr="watchers_count" Id="WatchersCount" Title="Watched" Converter="Int"/>
        <JsonPath Expr="language" Id="Language" Title="Language" Converter="String"/>
        <JsonPath Expr="forks_count" Id="ForksCount" Title="Forks" Converter="Int"/>
        <JsonPath Expr="open_issues_count" Id="OpenIssuesCount" Title="Open Issues" Converter="Int"/>
        <JsonPath Expr="master_branch" Id="MasterBranch" Title="Master Branch" Converter="String" Checked="false"/>
        <JsonPath Expr="default_branch" Id="DefaultBanch" Title="Default Branch" Converter="String" Checked="false"/>
        <JsonPath Expr="score" Id="Score" Title="Score" Converter="Int"/>
      </JsonPath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

</Suite>