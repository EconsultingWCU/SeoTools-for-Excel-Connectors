<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="Social" Title="_YahooGeminiAuth" Id="_YahooGeminiAuth" RequireVersion="8.1" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/_YahooGeminiAuth.xml" HelpUrl="http://seotoolsforexcel.com/_YahooGeminiAuth/">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <ConnectorAuthenticator LoginConnector="AccessToken" StayAuthenticated="true"/>

  <Settings>
    <Text Id="ClientId" Title="Client ID" Required="true"/>
    <Text Id="ClientSecret" Title="Client Secret" Required="true"/>
  </Settings>

  <BrowserConnector Id="Authorize" Type="Popup" TokenParam="code" TokenName="TempCode">
    <Url>
      <![CDATA[
           https://api.login.yahoo.com/oauth2/request_auth?client_id=dj0yJmk9bXYwOU1Oc3V2NURVJnM9Y29uc3VtZXJzZWNyZXQmc3Y9MCZ4PWE4&response_type=code&state=@(RandomString(15))&redirect_uri=https://seotoolsforexcel.com
        ]]>
    </Url>
  </BrowserConnector>

  <RestConnector Id="AccessToken">
    <Prepare>
      <Connector Id="Authorize"/>
    </Prepare>
    <Fetch>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>application/x-www-form-urlencoded</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
        <RequestForm>
          <Param Name="client_id">@(Model.ClientId)</Param>
          <Param Name="client_secret">@(Model.ClientSecret)</Param>
          <Param Name="code">@(Model.TempCode)</Param>
          <Param Name="grant_type">authorization_code</Param>
          <Param Name="redirect_uri">https://seotoolsforexcel.com</Param>
        </RequestForm>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
          https://api.login.yahoo.com/oauth2/get_token
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.access_token" Id="AccessToken"/>
    </Parse>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[
    private static Random random = new Random();
    public string RandomString(int length)
    {
      const string chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      return new string(Enumerable.Repeat(chars, length)
      .Select(s => s[random.Next(s.Length)]).ToArray());
    }
    ]]>


    string CreateBasicAuth()
    {
      return Convert.ToBase64String(ASCIIEncoding.ASCII.GetBytes(Model.ClientId + ":" + Model.ClientSecret));
    }
  </RazorFunctions>
</Suite>