<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="_2StepOAuth" Title="ZohoCRM" Id="Zoho CRM" RequireVersion="8.1" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/ZohoCRM.xml" HelpUrl="http://seotoolsforexcel.com/zoho-crm/">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <DefaultTwoStepOAuthAuthenticator
    StayAuthenticated="true"
    AuthUrl="https://accounts.zoho.com/oauth/v2/auth?scope=ZohoCRM.modules.ALL&amp;client_id=@(Model.ClientId)&amp;response_type=code&amp;access_type=online&amp;redirect_uri=@(Model.RedirectUri)"
    AuthCodeName="code" 
    AccessTokenConnectorId="AccessToken"
  />

  <Settings HelpUrl="http://seotoolsforexcel.com/zoho-crm/" HelpText="What's this?">
    <Text Id="ClientId" Title="Client ID" Required="true"/>
    <Text Id="ClientSecret" Title="Client Secret" Required="true"/>
  </Settings>

  <Resources>
    <Resource Id="Headers">
      <HttpSettings>
        <RequestHeaders>
          <Header Name="Authorization">Bearer @(Model.Authenticator.AccessToken)</Header>
        </RequestHeaders>
      </HttpSettings>
    </Resource>
    <Resource Id="Fail">
      <Fail>
        <JsonPath Expr="$.message"/>
      </Fail>
    </Resource>
  </Resources>

  <RestConnector Id="AccessToken" Hidden="true">
    <Parameters>
      <Text Id="AuthCode"/>
      <Text Id="RedirectUri"/>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>application/x-www-form-urlencoded</RequestContentType>
        <RequestHeaders>
          <Header Name="Accept">application/json</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://accounts.zoho.com/oauth/v2/token?
        code=@(Model.AuthCode)
        &redirect_uri=@(Model.RedirectUri)
        &client_id=@(Model.ClientId)
        &client_secret=@(Model.ClientSecret)
        &grant_type=authorization_code
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Id="Token" Name="Token" Expr="$.access_token"/>
    </Parse>
  </RestConnector>

  <RestConnector Id="Leads" Title="Leads">
    <Fetch>
      <Resource Id="Headers"/>
      <Fetch.Url>
        <![CDATA[
        https://www.zohoapis.com/crm/v2/leads
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.data.*">
        <JsonPath Expr="id" Id="Id" Title="Id" Converter="Int"/>
        <JsonPath Expr="First_Name" Id="FirstName" Title="First Name" Converter="String"/>
        <JsonPath Expr="Last_Name" Id="LastName" Title="Last Name" Converter="String"/>
        <JsonPath Expr="Mobile" Id="Mobile" Title="Mobile" Converter="String"/>
      </JsonPath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

</Suite>