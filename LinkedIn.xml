<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="_OAuth" Title="LinkedIn2" Id="LinkedIn" RequireVersion="7.0" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/LinkedIn.xml" HelpUrl="http://seotoolsforexcel.com/linkedin/">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <DefaultTwoStepOAuthAuthenticator
          StayAuthenticated="true"
          AuthUrl="https://www.linkedin.com/oauth/v2/authorization?client_id=@(Model.ClientId)&amp;response_type=code&amp;state=@(Utils.NewGuid())&amp;redirect_uri=@(Model.RedirectUri)"
          AuthCodeName="code" 
          AccessTokenConnectorId="AccessToken"
  />

  <Settings HelpUrl="http://seotoolsforexcel.com/linkedin/" HelpText="What's this?">
    <Text Id="ClientId" Title="Client ID" Required="true"/>
    <Text Id="ClientSecret" Title="Client Secret" Required="true"/>
  </Settings>

  <!--
  TODO:
  Settings -> Cancel is not workings & mouse. 
  Test functions
  Error handle
  Testing out all the others
  -->

  <Resources>
    <Resource Id="Headers">
      <HttpSettings>
        <RequestHeaders>
          <Header Name="Authorization">Bearer @(Model.Authenticator.AccessToken)</Header>
        </RequestHeaders>
      </HttpSettings>
    </Resource>
    <Resource Id="Fail">
      <Fail>
        <JsonPath Expr="$.message"/>
      </Fail>
    </Resource>
  </Resources>

  <RestConnector Id="AccessToken" Hidden="true">
    <Parameters>
      <Text Id="AuthCode"/>
      <Text Id="RedirectUri"/>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestContentType>application/x-www-form-urlencoded</RequestContentType>
        <RequestHeaders>
          <Header Name="Accept">application/json</Header>
        </RequestHeaders>
        <RequestBody>
          <![CDATA[grant_type=authorization_code&client_id=@(Model.ClientId)&client_secret=@(Model.ClientSecret)&code=@(Model.AuthCode)&redirect_uri=@(Utils.UrlEncode(Model.RedirectUri))]]>
        </RequestBody>
      </HttpSettings>
      <Fetch.Url>
        https://www.linkedin.com/oauth/v2/accessToken
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Id="Token" Name="Token" Expr="$.access_token"/>
    </Parse>
  </RestConnector>

  <RestConnector Id="MyCompanies" Title="My Companies">
    <Fetch>
      <Resource Id="Headers"/>
      <Fetch.Url>
        <![CDATA[
        https://api.linkedin.com/v1/people/~?format=json
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="id" Id="Id" Title="Id" Converter="Int"/>
      <JsonPath Expr="firstName" Id="FirstName" Title="First Name" Converter="String"/>
      <JsonPath Expr="lastName" Id="LastName" Title="Last Name" Converter="String"/>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

</Suite>