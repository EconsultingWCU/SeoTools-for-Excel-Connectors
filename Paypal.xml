<?xml version="1.0" encoding="utf-8" ?>
<Suite Title="Paypal" Id="Paypal" Category="Payments" RequireVersion="7.0" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/Paypal.xml" HelpUrl="http://seotoolsforexcel.com/paypal/" HelpText="Documentation">

  <Author Name="Victor Sandberg" Url="http://community.seotoolsforexcel.com/users/diskborste/activity" />

  <Settings HelpText="What's this?" HelpUrl="http://seotoolsforexcel.com/paypal/">
    <Text Id="Id" Title="Id" Required="true" HelpUrl="http://seotoolsforexcel.com/paypal/"/>
    <Text Id="Secret" Title="Secret" Required="true" HelpUrl="http://seotoolsforexcel.com/paypal/"/>
  </Settings>

  <RestConnector Id="Authentication" HelpUrl="https://developer.paypal.com/docs/api/overview/#make-your-first-call" Hidden="true">
    <Fetch>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
				<RequestContentType>x-www-form-urlencoded</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
          <Header Name='Accept'>application/json</Header>
          <Header Name='Accept-Language'>en_US</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
				https://api.paypal.com/v1/oauth2/token?grant_type=client_credentials
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="access_token" Id="Token"/>
    </Parse>
    <Fail>
      <JsonPath Expr="user_message"/>
    </Fail>
  </RestConnector>

  <RestConnector Id="Payments" Title="Payments" HelpUrl="https://developer.paypal.com/docs/api/payments/v1/#payment_list" HelpText="Shows the payments that are made to the merchant who makes the call.">
    <Parameters>
      <Text Id="PayeeId" Title="Filter by Payee Id" Debug.DefaultValue="" Required="false"/>
      <DateInterval Id="DateInterval" Title="Date Interval" Required="false" Nullable="true"/>
    </Parameters>
    <Prepare>
      <Connector Id="Authentication"/>
    </Prepare>
    <Paging PageSize="20" EvenPages="true"/>
    <Fetch>
      <HttpSettings>
				<RequestContentType>application/json</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Bearer @(Model.Token)</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
				https://api.paypal.com/v1/payments/payment
				?count=@(Model.PageCursor.NextTake)
				&start_index=@(Model.PageCursor.NextSkip)
        @if(!string.IsNullOrEmpty(Model.PayeeId))
        {
          @: &payee_id=@(Model.PayeeId)
        }
        @if(Model.DateInterval.StartDate != null && Model.DateInterval.EndDate != null)
        {
          @: &start_time=@(((DateTimeOffset)Model.DateInterval.StartDate).ToString("yyyy-MM-dd"))T00:00:00.000Z
          @: &end_time=@(((DateTimeOffset)Model.DateInterval.EndDate).ToString("yyyy-MM-dd"))T23:59:59.000Z
        }
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="payments.*">
				<JsonPath Expr="id" Id="Id" Title="Id" Converter="String" DefaultValue="" HelpText=""/>
				<JsonPath Expr="create_time" Id="Created" Title="Created" Converter="DateTime" HelpText=""/>
				<JsonPath Expr="intent" Id="Intent" Title="Intent" Converter="String" HelpText=""/>
				<JsonPath Expr="state" Id="State" Title="State" Converter="String" HelpText=""/>
				<JsonPath Expr="cart" Id="Cart" Title="Cart" Converter="String" HelpText=""/>
				<JsonPath Expr="payer.payment_method" Id="PayerMethod" Title="Payer Method" Converter="String" HelpText=""/>
				<JsonPath Expr="payer.status" Id="PayerStatus" Title="Payer Status" Converter="String" HelpText=""/>
				<JsonPath Expr="payer.payer_info.payer_id" Id="PayerId" Title="Payer Id" Converter="String" HelpText=""/>
				<JsonPath Expr="payer.payer_info.email" Id="PayerEmail" Title="Payer Email" Converter="String" HelpText=""/>
				<JsonPath Expr="payer.payer_info.first_name" Id="PayerFirstName" Title="Payer First Name" Converter="String" HelpText=""/>
				<JsonPath Expr="payer.payer_info.last_name" Id="PayerLastName" Title="Payer Last Name" Converter="String" HelpText=""/>
				<JsonPath Expr="payer.payer_info.email" Id="PayerEmail" Title="Payer Email" Converter="String" HelpText=""/>
				<JsonPath Expr="payer.payer_info.country_code" Id="PayerCountryCode" Title="Payer Country Code" Converter="String" HelpText=""/>
				<JsonPath Expr="transactions[0].payee.merchant_id" Id="PayeeMerchantId" Title="Payee Merchant Id" Converter="String" HelpText=""/>
				<JsonPath Expr="transactions[0].description" Id="Description" Title="Description" Converter="String" HelpText=""/>
				<JsonPath Expr="transactions[0].soft_descriptor" Id="SoftDescriptor" Title="Soft Descriptor" Converter="String" DefaultValue="" HelpText=""/>
				<JsonPath Expr="transactions[0].amount.total" Id="Amount" Title="Amount" Converter="String" HelpText=""/>
				<JsonPath Expr="transactions[0].amount.currency" Id="Currency" Title="Currency" Converter="String" HelpText=""/>
			</JsonPath>
    </Parse>
    <Fail>
      <JsonPath Expr="message"/>
    </Fail>
  </RestConnector>

  <RestConnector Id="PaymentLookup" Title="Payment Lookup" HelpUrl="https://developer.paypal.com/docs/api/payments/v1/#payment_get" HelpText="Shows details for a payment, by ID.">
    <Parameters>
      <Text Id="PaymentId" Title="Payment Id" Debug.DefaultValue="PAY-6279587608240660WKYMIZGA" Required="true"/>
    </Parameters>
    <Prepare>
      <Connector Id="Authentication"/>
    </Prepare>
    <Fetch>
      <HttpSettings>
				<RequestContentType>application/json</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Bearer @(Model.Token)</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
				https://api.paypal.com/v1/payments/payment/@(Model.PaymentId)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="id" Id="Id" Title="Id" Converter="String" DefaultValue="" HelpText=""/>
			<JsonPath Expr="create_time" Id="Created" Title="Created" Converter="DateTime" HelpText=""/>
			<JsonPath Expr="intent" Id="Intent" Title="Intent" Converter="String" HelpText=""/>
			<JsonPath Expr="state" Id="State" Title="State" Converter="String" HelpText=""/>
			<JsonPath Expr="cart" Id="Cart" Title="Cart" Converter="String" HelpText=""/>
			<JsonPath Expr="payer.payment_method" Id="PayerMethod" Title="Payer Method" Converter="String" HelpText=""/>
			<JsonPath Expr="payer.status" Id="PayerStatus" Title="Payer Status" Converter="String" HelpText=""/>
			<JsonPath Expr="payer.payer_info.payer_id" Id="PayerId" Title="Payer Id" Converter="String" HelpText=""/>
			<JsonPath Expr="payer.payer_info.email" Id="PayerEmail" Title="Payer Email" Converter="String" HelpText=""/>
			<JsonPath Expr="payer.payer_info.first_name" Id="PayerFirstName" Title="Payer First Name" Converter="String" HelpText=""/>
			<JsonPath Expr="payer.payer_info.last_name" Id="PayerLastName" Title="Payer Last Name" Converter="String" HelpText=""/>
			<JsonPath Expr="payer.payer_info.email" Id="PayerEmail" Title="Payer Email" Converter="String" HelpText=""/>
			<JsonPath Expr="payer.payer_info.country_code" Id="PayerCountryCode" Title="Payer Country Code" Converter="String" HelpText=""/>
			<JsonPath Expr="transactions[0].payee.merchant_id" Id="PayeeMerchantId" Title="Payee Merchant Id" Converter="String" HelpText=""/>
			<JsonPath Expr="transactions[0].description" Id="Description" Title="Description" Converter="String" HelpText=""/>
			<JsonPath Expr="transactions[0].soft_descriptor" Id="SoftDescriptor" Title="Soft Descriptor" Converter="String" DefaultValue="" HelpText=""/>
			<JsonPath Expr="transactions[0].amount.total" Id="Amount" Title="Amount" Converter="Double" HelpText=""/>
			<JsonPath Expr="transactions[0].amount.currency" Id="Currency" Title="Currency" Converter="String" HelpText=""/>
    </Parse>
    <Fail>
      <JsonPath Expr="message"/>
    </Fail>
  </RestConnector>

  <RestConnector Id="Disputes" Title="Disputes" HelpUrl="https://developer.paypal.com/docs/api/customer-disputes/v1/#disputes_get-disputes" HelpText="Lists disputes with customers.">
    <Parameters>
      <Text Id="TransactionId" Title="Filter by Disputed Transaction Id" Debug.DefaultValue="" Required="false"/>
    </Parameters>
    <Prepare>
      <Connector Id="Authentication"/>
    </Prepare>
    <Paging PageSize="50" EvenPages="true"/>
    <Fetch>
      <HttpSettings>
				<RequestContentType>application/json</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Bearer @(Model.Token)</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
				https://api.paypal.com/v1/customer/disputes?
				?next_page_token=@(Model.PageCursor.Page+1)
				&page_size=@(Model.PageCursor.NextTake)
        @if(!string.IsNullOrEmpty(Model.TransactionId))
        {
          @: &disputed_transaction_id=@(Model.TransactionId)
        }
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="items.*">
				<JsonPath Expr="dispute_id" Id="DisputeId" Title="Dispute Id" Converter="String" HelpText=""/>
				<JsonPath Expr="create_time" Id="Created" Title="Created" Converter="DateTime" HelpText=""/>
				<JsonPath Expr="update_time" Id="Updated" Title="Updated" Converter="DateTime" HelpText=""/>
				<JsonPath Expr="reason" Id="Reason" Title="Reason" Converter="String" HelpText=""/>
				<JsonPath Expr="status" Id="Status" Title="Status" Converter="String" HelpText=""/>
				<JsonPath Expr="dispute_outcome.outcome_code" Id="Outcome" Title="Outcome" Converter="String" HelpText=""/>
				<JsonPath Expr="dispute_amount.value" Id="Amount" Title="Amount" Converter="Double" HelpText=""/>
				<JsonPath Expr="dispute_amount.currency_code" Id="Currency" Title="Currency" Converter="String" HelpText=""/>
				<JsonPath Expr="disputed_transactions[0].buyer_transaction_id" Id="BuyerTransactionId" Title="Buyer Transaction Id" Converter="String" HelpText=""/>
				<JsonPath Expr="disputed_transactions[0].buyer.email" Id="BuyerEmail" Title="Buyer Email" Converter="String" HelpText=""/>
				<JsonPath Expr="disputed_transactions[0].buyer.name" Id="BuyerName" Title="Buyer Name" Converter="String" HelpText=""/>
				<JsonPath Expr="disputed_transactions[0].seller_transaction_id" Id="SellerTransactionId" Title="Seller Transaction Id" Converter="String" HelpText=""/>
				<JsonPath Expr="disputed_transactions[0].seller.email" Id="SellerEmail" Title="Seller Email" Converter="String" HelpText=""/>
				<JsonPath Expr="disputed_transactions[0].seller.name" Id="SellerName" Title="Seller Name" Converter="String" HelpText=""/>
				<JsonPath Expr="disputed_transactions[0].seller.merchant_id" Id="SellerMerchantId" Title="Seller Merchant Id" Converter="String" HelpText=""/>
			</JsonPath>
    </Parse>
    <Fail>
      <JsonPath Expr="message"/>
    </Fail>
  </RestConnector>

  <RestConnector Id="DisputeLookup" Title="Dispute Lookup" HelpUrl="https://developer.paypal.com/docs/api/customer-disputes/v1/#disputes_get-dispute" HelpText="Shows details for a dispute, by ID.">
    <Parameters>
      <Text Id="DisputeId" Title="Dispute Id" Debug.DefaultValue="" Required="true"/>
    </Parameters>
    <Prepare>
      <Connector Id="Authentication"/>
    </Prepare>
    <Fetch>
      <HttpSettings>
				<RequestContentType>application/json</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Bearer @(Model.Token)</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
				https://api.paypal.com/v1/customer/disputes/@(Model.DisputeId)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="dispute_id" Id="DisputeId" Title="Dispute Id" Converter="String" HelpText=""/>
			<JsonPath Expr="create_time" Id="Created" Title="Created" Converter="DateTime" HelpText=""/>
			<JsonPath Expr="update_time" Id="Updated" Title="Updated" Converter="DateTime" HelpText=""/>
			<JsonPath Expr="reason" Id="Reason" Title="Reason" Converter="String" HelpText=""/>
			<JsonPath Expr="status" Id="Status" Title="Status" Converter="String" HelpText=""/>
			<JsonPath Expr="dispute_outcome.outcome_code" Id="Outcome" Title="Outcome" Converter="String" HelpText=""/>
			<JsonPath Expr="dispute_amount.value" Id="Amount" Title="Amount" Converter="Double" HelpText=""/>
			<JsonPath Expr="dispute_amount.currency_code" Id="Currency" Title="Currency" Converter="String" HelpText=""/>
			<JsonPath Expr="disputed_transactions[0].buyer_transaction_id" Id="BuyerTransactionId" Title="Buyer Transaction Id" Converter="String" HelpText=""/>
			<JsonPath Expr="disputed_transactions[0].buyer.email" Id="BuyerEmail" Title="Buyer Email" Converter="String" HelpText=""/>
			<JsonPath Expr="disputed_transactions[0].buyer.name" Id="BuyerName" Title="Buyer Name" Converter="String" HelpText=""/>
			<JsonPath Expr="disputed_transactions[0].seller_transaction_id" Id="SellerTransactionId" Title="Seller Transaction Id" Converter="String" HelpText=""/>
			<JsonPath Expr="disputed_transactions[0].seller.email" Id="SellerEmail" Title="Seller Email" Converter="String" HelpText=""/>
			<JsonPath Expr="disputed_transactions[0].seller.name" Id="SellerName" Title="Seller Name" Converter="String" HelpText=""/>
			<JsonPath Expr="disputed_transactions[0].seller.merchant_id" Id="SellerMerchantId" Title="Seller Merchant Id" Converter="String" HelpText=""/>
    </Parse>
    <Fail>
      <JsonPath Expr="message"/>
    </Fail>
  </RestConnector>

	<RazorFunctions>
	<![CDATA[
	String CreateBasicAuth()
	{
		string AuthString = Convert.ToBase64String(ASCIIEncoding.ASCII.GetBytes(Model.Id + ":" + Model.Secret));
		return AuthString;
	}
	]]>
</RazorFunctions>

</Suite>