<?xml version="1.0" encoding="utf-8" ?>
<Suite Category="Social" Title="_TwitterAuth" Id="_TwitterAuth" RequireVersion="8.1" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/_TwitterAuth.xml" HelpUrl="http://seotoolsforexcel.com/_twitterauth/">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <Resources>
    <Resource Id="SelectCountry">
      <Select Id="Country" Title="Country" Required="true" DefaultValue="US">
        <DataSource>
          <Item Id="AR" Title="Argentina"/>
          <Item Id="AU" Title="Australia"/>
          <Item Id="AT" Title="Austria"/>
          <Item Id="BR" Title="Brazil"/>
          <Item Id="CA" Title="Canada"/>
          <Item Id="DK" Title="Denmark"/>
          <Item Id="FI" Title="Finland"/>
          <Item Id="FR" Title="France"/>
          <Item Id="DE" Title="Germany"/>
          <Item Id="HK" Title="Hong Kong"/>
          <Item Id="IN" Title="India"/>
          <Item Id="IT" Title="Italy"/>
          <Item Id="JP" Title="Japan"/>
          <Item Id="MX" Title="Mexico"/>
          <Item Id="NL" Title="Netherlands"/>
          <Item Id="NO" Title="Norway"/>
          <Item Id="PL" Title="Poland"/>
          <Item Id="RU" Title="Russian Federation"/>
          <Item Id="SG" Title="Singapore"/>
          <Item Id="ZA" Title="South Africa"/>
          <Item Id="ES" Title="Spain"/>
          <Item Id="SE" Title="Sweden"/>
          <Item Id="CH" Title="Switzerland"/>
          <Item Id="TR" Title="Turkey"/>
          <Item Id="US" Title="USA"/>
          <Item Id="GB" Title="United Kingdom"/>
        </DataSource>
      </Select>
    </Resource>
    <Resource Id="SelectCurrency">
      <Select Id="Currency" Title="Currency" Required="true" DefaultValue="USD">
        <DataSource>
          <Item Id="USD" Title="USD"/>
          <Item Id="EUR" Title="EUR"/>
          <Item Id="GBP" Title="GBP"/>
        </DataSource>
      </Select>
    </Resource>
  </Resources>

  <!--<ConnectorAuthenticator LoginConnector="AccessToken" LogoutConnector="" StayAuthenticated="true"/>-->

  <Settings HelpText="What's this?" HelpUrl="http://seotoolsforexcel.com/sqlconnectors/">
    <Text Id="OAuthConsumerKey" Title="OAuth Consumer Key" Required="true"/>
    <Text Id="OAuthConsumerSecret" Title="OAuth Consumer Secret" Required="true"/>

    <Text Id="Token"/>
    <Text Id="TokenSecret"/>
  </Settings>

  <RestConnector Id="RequestToken" Title="RequestToken" Hidden="false" HelpUrl="https://developer.twitter.com/en/docs/basics/authentication/api-reference/request_token">
    <Fetch>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestHeaders>
          <Header Name='Authorization'>OAuth @(CreateOauthInitial())</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
           https://api.twitter.com/oauth/request_token
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Regex Expr="oauth_token=([^&amp;]+)" Group="1" Id="RequestToken"/>
      <Regex Expr="oauth_token_secret=([^&amp;]+)" Group="1" Id="RequestTokenSecret"/>
    </Parse>
  </RestConnector>

  <BrowserConnector Id="Authenticate" Title="Authenticate" Type="Popup" TokenParam="oauth_token,oauth_verifier" TokenName="OauthToken,OauthVerifier">
    <Prepare>
      <Connector Id="RequestToken"/>
    </Prepare>
    <Url>
      <![CDATA[
        https://api.twitter.com/oauth/authenticate?oauth_token=@(Model.RequestToken)&oauth_token_secret=@(Model.RequestTokenSecret)&oauth_callback_confirmed=true
      ]]>
    </Url>
  </BrowserConnector>

  <RestConnector Id="AccessToken" HelpUrl="https://developer.twitter.com/en/docs/basics/authentication/api-reference/authenticate">
    <Prepare>
      <Connector Id="Authenticate"/>
    </Prepare>
    <Fetch>
      <HttpSettings>
        <RequestMethod>POST</RequestMethod>
        <RequestHeaders>
          <Header Name='Authorization'>OAuth @(CreateOauthInitial())</Header>
        </RequestHeaders>
        <RequestContentType>application/x-www-form-urlencoded</RequestContentType>
        <RequestForm>
          <Param Name='oauth_verifier'>@(Model.OauthVerifier)</Param>
        </RequestForm>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://api.twitter.com/oauth/access_token?oauth_token=@(Model.OauthToken)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Regex Expr="oauth_token=([^&amp;]+)" Group="1" Id="AccessToken"/>
      <Regex Expr="oauth_token_secret=([^&amp;]+)" Group="1" Id="AccessTokenSecret"/>
    </Parse>
  </RestConnector>

  <RestConnector Id="RetweetsOfMe" Title="Retweets Of Me" HelpUrl="https://developer.twitter.com/en/docs/tweets/post-and-engage/api-reference/get-statuses-retweets_of_me">
    <Parameters>
      <Number Id="Limit" Title="Max results" Required="true" DefaultValue="20" MinValue="1" MaxValue="100"/>
    </Parameters>
    <Fetch>
      <HttpSettings>
        <RequestHeaders>
          <Header Name='Authorization'>OAuth @(CreateOauth())</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        https://api.twitter.com/1.1/statuses/retweets_of_me.json?count=@(Model.Limit)
        ]]>
      </Fetch.Url>
      <Parse>
        <JsonPath Expr="$.*">
          <JsonPath Expr="text" Id="Text" Converter="String" />
        </JsonPath>
      </Parse>
    </Fetch>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[

    string CreateOauthInitial(){
      string oauth = "";
      string nonce = GenerateRandomString(20);
      string timestamp = GetTimestamp().ToString();

      string parameters = getParameters(nonce, timestamp, true);
      string signatureBase = GetSignatureBase("https://api.twitter.com/oauth/request_token", parameters);
			string signature = Utils.HmacSha1(signatureBase, Utils.UrlEncode(Model.OAuthConsumerSecret) + "&");

      oauth = getParameters(nonce, timestamp, false);
      oauth += ", oauth_signature=" + "\"" + Utils.UrlEncode(signature) + "\"";

      return oauth;
    }

     string CreateOauth(){
      string oauth = "";

      return oauth;
    }

    string getParameters(string nonce, string timestamp, bool url = true){
      Dictionary<string, string> parameters = new Dictionary<string, string>();
      string generated = "";

      parameters.Add("oauth_callback", Utils.UrlEncode("https://seotoolsforexcel.com"));
      parameters.Add("oauth_consumer_key", Model.OAuthConsumerKey);
      parameters.Add("oauth_nonce", nonce);
      parameters.Add("oauth_signature_method", "HMAC-SHA1");
      parameters.Add("oauth_timestamp", timestamp);
      parameters.Add("oauth_version", "1.0");

      if (url){
        generated = String.Join("&", parameters.Select(x => x.Key + "=" + x.Value).ToArray());
      }
      else {
        generated = String.Join(", ", parameters.Select(x => x.Key + "=" + "\"" + x.Value + "\"").ToArray());
      }
      return generated;
    }

    public string GenerateRandomString(int length) {
      Random random = new Random();
      string characters = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
      StringBuilder result = new StringBuilder(length);
      for (int i = 0; i < length; i++) {
        result.Append(characters[random.Next(characters.Length)]);
      }
      return result.ToString();
    }

    long GetTimestamp(){
     return DateTimeOffset.UtcNow.ToUnixTimeSeconds();
    }

    string GetSignatureBase(string url, string parameters){
      string x = "POST&" + Utils.UrlEncode(url) + "&" + Utils.UrlEncode(parameters);
      return x;
    }

    string GetSignature(string signatureBase){
      string xx = Utils.HmacSha1(signatureBase, Utils.UrlEncode(Model.OAuthConsumerSecret) + "&");
			return xx;
    }

    ]]>
  </RazorFunctions>

</Suite>